name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. 0.6.1)'
        required: true
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v6
        with:
          ref: main

      - name: Validate CHANGELOG entry
        run: |
          if ! grep -q "## v${{ inputs.version }}" CHANGELOG.md; then
            echo "::error::Missing CHANGELOG entry for v${{ inputs.version }}"
            exit 1
          fi

      - name: Validate version.txt
        run: |
          if ! grep -q "${{ inputs.version }}" cmd/scip/version.txt; then
            echo "::error::cmd/scip/version.txt doesn't match version ${{ inputs.version }}"
            exit 1
          fi

      - name: Create and push tags
        run: |
          TAG="v${{ inputs.version }}"
          BINDINGS_TAG="bindings/go/scip/$TAG"
          git tag "$TAG" 2>/dev/null || echo "Tag $TAG already exists"
          git tag "$BINDINGS_TAG" 2>/dev/null || echo "Tag $BINDINGS_TAG already exists"
          git push origin "$TAG" "$BINDINGS_TAG" 2>/dev/null || echo "Tags already pushed"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="v${{ inputs.version }}"
          if gh release view "$TAG" &>/dev/null; then
            echo "Release $TAG already exists, skipping creation"
            exit 0
          fi
          {
            echo "See the [CHANGELOG](https://github.com/sourcegraph/scip/blob/main/CHANGELOG.md) to see what's new in scip $TAG."
            echo ''
            echo 'Download the CLI for your current platform using:'
            echo ''
            echo '```bash'
            echo 'env \'
            echo "  TAG=\"$TAG\" \\"
            echo '  OS="$(uname -s | tr '"'"'[:upper:]'"'"' '"'"'[:lower:]'"'"')" \'
            echo '  ARCH="$(uname -m | sed -e '"'"'s/x86_64/amd64/'"'"')" \'
            echo '  bash -c '"'"'curl -L "https://github.com/sourcegraph/scip/releases/download/$TAG/scip-$OS-$ARCH.tar.gz"'"'"' \'
            echo '| tar xzf - scip'
            echo '```'
          } | gh release create "$TAG" --title "scip $TAG" --notes-file -

  release-crate:
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          ref: v${{ inputs.version }}
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: DeterminateSystems/magic-nix-cache-action@v13
      - name: Publish crate
        run: |
          OUTPUT=$(nix develop -c cargo publish --token '${{ secrets.CRATES_TOKEN }}' 2>&1) && exit 0
          if echo "$OUTPUT" | grep -q "already uploaded"; then
            echo "Crate version already published, skipping"
          else
            echo "$OUTPUT"
            exit 1
          fi
        working-directory: bindings/rust

  build-go-binaries:
    needs: publish
    strategy:
      matrix:
        include:
          - runner: ubuntu-latest
            asset_name: scip-linux-amd64
          - runner: ubuntu-latest-arm
            asset_name: scip-linux-arm64
          - runner: macos-13
            asset_name: scip-darwin-amd64
          - runner: macos-latest
            asset_name: scip-darwin-arm64

    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v6
        with:
          ref: v${{ inputs.version }}
      - uses: DeterminateSystems/nix-installer-action@v21
      - uses: DeterminateSystems/magic-nix-cache-action@v13
      - name: Build
        run: nix build .#scip
      - name: Package
        env:
          ASSET: ${{ matrix.asset_name }}
        run: |
          tar czf "$ASSET.tar.gz" -C result/bin scip -C "$GITHUB_WORKSPACE" LICENSE
          sha256sum "$ASSET.tar.gz" > "$ASSET.tar.gz.sha256" 2>/dev/null || \
            shasum -a 256 "$ASSET.tar.gz" > "$ASSET.tar.gz.sha256"
      - name: Upload release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ASSET: ${{ matrix.asset_name }}
        run: gh release upload "v${{ inputs.version }}" "$ASSET.tar.gz" "$ASSET.tar.gz.sha256" --clobber
